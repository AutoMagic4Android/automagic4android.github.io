<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>AutoMagic4Android</title>
		<meta name="description" content="Auto Magic For Android">
		<meta name="author" content="Bluscream">

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

		<!--[if lt IE 9]>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
		<![endif]-->
		<style type="text/css">
			.hidden { display:none; }
		</style>
		<script type="text/javascript">
			var parseURLinput = function() { }
		</script>
	</head>
	<body linkifying="true" style="color:#999999;background-color:#3b3b3b">
		<img align="right" src="https://automagic4android.com/images/automagic_title_587.png"/>
		<h1>AutoMagic Flow Info</h1>
		<div id="start">
		  Load flow from URL:&nbsp;
		  <input type='text' id='flow_url' style="width:500px" value=''>&nbsp;
		  <input type='submit' value='Load' onclick="loadFlow($('#flow_url').val());window.location.href+='#'+$('#flow_url').val()">
		  <br><br>Load flow local file:&nbsp;
		  <input id="flow_file" type="file" accept="application/xml">&nbsp;
		  <!--input type='submit' value='Load' onclick="loadFlow($('#flow_file').val());window.location.href=window.location.protocol+'//'+window.location.host+'/'+window.location.pathname+'#'+$('#flow_file').val()"-->
		  <script type="text/css">
			  function handleFileSelect(evt) {
			  	console.log("test");
				var files = evt.target.files; // FileList object
				// Loop through the FileList and render image files as thumbnails.
				for (var i = 0, f; f = files[i]; i++) {
				  // Only process image files.
				  if (!f.type.match('image.*')) {
					continue;
				  }
				  var reader = new FileReader();
				  // Closure to capture the file information.
				  reader.onload = (function(theFile) {
					return function(e) {
					  // Render thumbnail.
					  var span = document.createElement('span');
					  span.innerHTML = ['<img class="thumb" src="', e.target.result,
						                '" title="', escape(theFile.name), '"/>'].join('');
					  document.getElementById('list').insertBefore(span, null);
					};
				  })(f);
				  // Read in the image file as a data URL.
				  reader.readAsDataURL(f);
				}
			  }
			  document.getElementById('flow_file').addEventListener('change', handleFileSelect, false);
		</script>
		</div>
		<h3 id="loading" class="hidden">Loading...</h3>
		<div id="flow" class="hidden">
			<h2>Flows</h2>
			<table id="flows" border="1">
				<tr>
					<th>#</th>
					<th>Enabled</th>
					<th>Group</th>
					<th>Name</th>
					<th>Execution Policy</th>
				</tr>
			</table><br>
			<h2>Triggers</h2>
			<table id="triggers" border="1">
				<tr>
					<th>#</th>
					<th>Enabled</th>
					<th>Type</th>
					<th>Name</th>
					<th>Method</th>
					<th>Package Name Filter</th>
					<th>Class Name Filter</th>
					<th>Use Default Name</th>
				</tr>
			</table><br>
			<h2>Conditions</h2>
			<table id="conditions" border="1">
				<tr>
					<th>#</th>
					<th>Type</th>
					<th>Name</th>
					<th>Expression</th>
					<th>Use Default Name</th>
				</tr>
			</table><br>
			<h2>Actions</h2>
			<table id="actions" border="1">
				<tr>
					<th>#</th>
					<th>Type</th>
					<th>Name</th>
				</tr>
			</table><br>
		</div>
		<script type="text/javascript">
			function parseInfo(flow) {
				i = 1;
				$(flow).find('flow').each(function(){
					_row = $("<tr />");
					_row.append("<td>"+i+"</td>");
		            _row.append("<td>"+$(this).find("enabled").text()+"</td>");
		            _row.append("<td>"+$(this).find("group").text()+"</td>");
		            _row.append("<td>"+$(this).find("name").text()+"</td>");
		            _row.append("<td>"+$(this).find("executionPolicy").text()+"</td>");
		            $("#flows").append(_row);
		            i += 1;
				});
			}
			function parseTriggers(flow) {
				i = 1;
				$(flow).find('trigger').each(function(){
					_row = $("<tr />");
					_row.append("<td>"+i+"</td>");
		            _row.append("<td>"+$(this).find("enabled").text()+"</td>");
		            _row.append("<td>"+this.getAttribute("type")+"</td>");
		            _row.append("<td>"+$(this).find("name").text()+"</td>");
		            _row.append("<td>"+$(this).find("method").text()+"</td>");
		            _row.append("<td>"+$(this).find("packageNameFilter").text()+"</td>");
		            _row.append("<td>"+$(this).find("classNameFilter").text()+"</td>");
		            _row.append("<td>"+$(this).find("useDefaultName").text()+"</td>");
		            $("#triggers").append(_row);
		            i += 1;
				});
			}
			function parseConditions(flow) {
				i = 1;
				$(flow).find('condition').each(function(){
					_row = $("<tr />");
					_row.append("<td>"+i+"</td>");
		            _row.append("<td>"+this.getAttribute("type")+"</td>");
		            _row.append("<td>"+$(this).find("name").text()+"</td>");
		            _row.append("<td>"+$(this).find("expression").text()+"</td>");
		            _row.append("<td>"+$(this).find("useDefaultName").text()+"</td>");
		            $("#conditions").append(_row);
		            i += 1;
				});
			}
			function parseActions(flow) {
				i = 1;
				$(flow).find('action').each(function(){
					_row = $("<tr />");
					_row.append("<td>"+i+"</td>");
		            _row.append("<td>"+this.getAttribute("type")+"</td>");
		            _row.append("<td>"+$(this).find("name").text()+"</td>");
		            $("#actions").append(_row);
		            i += 1;
				});
			}
			function parseURL(url) {
				if (url.indexOf("?") !== -1) {
					flow_url = url.substr(url.indexOf('?')+1);
					console.log("Flow URL: " + flow_url);
					var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
					'((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
					'((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
					'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
					'(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
					'(\\#[-a-z\\d_]*)?$','i'); // fragment locator
					if(pattern.test(flow_url)) {
						return [url.substr(0,url.indexOf('?')), flow_url]
					}
				}
				return false;
			}
			function loadFlow(url) {
				$.ajax({
				    type: "GET",
				    url: "https://cors-anywhere.herokuapp.com/"+url,
				    cache: false,
				    dataType: "xml",
				    success: function(flow) {
				    	$("#loading").removeClass("hidden")
				    	console.log(flow);
				    	console.log('---')
				    	$('table>tr').not(':first').remove();
				    	$('#start').addClass("hidden");
				    	$('#flow').removeClass("hidden");
				        parseInfo(flow);
				        parseTriggers(flow);
				        parseConditions(flow);
				        parseActions(flow);
				    	$("#loading").text("Created with AutoMagic For Android v"+flow.documentElement.getAttribute("version"));
				    }
				});
			}
			$(document).ready(function () {
				url = parseURL(window.location.href)
				if (url == false) { return; }
				loadFlow(url[1]);
				// https://raw.githubusercontent.com/Bluscream/AutoMagicFlows/master/flow_New_activity.xml
			});
		</script>
	</body>
</html>
